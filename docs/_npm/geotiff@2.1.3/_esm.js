/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/geotiff@2.1.3/dist-module/geotiff.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{getFloat16 as t}from"../@petamoriken/float16@3.8.7/_esm.js";import e from"../xml-utils@1.10.1/get-attribute.js._esm.js";import r from"../xml-utils@1.10.1/find-tags-by-name.js._esm.js";import i from"../quick-lru@6.1.2/_esm.js";const n={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},o={};for(const t in n)n.hasOwnProperty(t)&&(o[n[t]]=parseInt(t,10));const s={256:"SHORT",257:"SHORT",258:"SHORT",259:"SHORT",262:"SHORT",273:"LONG",274:"SHORT",277:"SHORT",278:"LONG",279:"LONG",282:"RATIONAL",283:"RATIONAL",284:"SHORT",286:"SHORT",287:"RATIONAL",296:"SHORT",297:"SHORT",305:"ASCII",306:"ASCII",338:"SHORT",339:"SHORT",513:"LONG",514:"LONG",1024:"SHORT",1025:"SHORT",2048:"SHORT",2049:"ASCII",3072:"SHORT",3073:"ASCII",33550:"DOUBLE",33922:"DOUBLE",34264:"DOUBLE",34665:"LONG",34735:"SHORT",34736:"DOUBLE",34737:"ASCII",42113:"ASCII"},a=[o.BitsPerSample,o.ExtraSamples,o.SampleFormat,o.StripByteCounts,o.StripOffsets,o.StripRowCounts,o.TileByteCounts,o.TileOffsets,o.SubIFDs],h={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},l={};for(const t in h)h.hasOwnProperty(t)&&(l[h[t]]=parseInt(t,10));const f={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,TransparencyMask:4,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},c={Unspecified:0,Assocalpha:1,Unassalpha:2},u={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"},g={};for(const t in u)u.hasOwnProperty(t)&&(g[u[t]]=parseInt(t,10));var p=Object.freeze({__proto__:null,fieldTagNames:n,fieldTags:o,fieldTagTypes:s,arrayFields:a,fieldTypeNames:h,fieldTypes:l,photometricInterpretations:f,ExtraSamplesValues:c,LercParameters:{Version:0,AddCompression:1},LercAddCompression:{None:0,Deflate:1,Zstandard:2},geoKeyNames:u,geoKeys:g});function d(t,e){const{width:r,height:i}=t,n=new Uint8Array(r*i*3);let o;for(let r=0,i=0;r<t.length;++r,i+=3)o=256-t[r]/e*256,n[i]=o,n[i+1]=o,n[i+2]=o;return n}function w(t,e){const{width:r,height:i}=t,n=new Uint8Array(r*i*3);let o;for(let r=0,i=0;r<t.length;++r,i+=3)o=t[r]/e*256,n[i]=o,n[i+1]=o,n[i+2]=o;return n}function y(t,e){const{width:r,height:i}=t,n=new Uint8Array(r*i*3),o=e.length/3,s=e.length/3*2;for(let r=0,i=0;r<t.length;++r,i+=3){const a=t[r];n[i]=e[a]/65536*256,n[i+1]=e[a+o]/65536*256,n[i+2]=e[a+s]/65536*256}return n}function m(t){const{width:e,height:r}=t,i=new Uint8Array(e*r*3);for(let e=0,r=0;e<t.length;e+=4,r+=3){const n=t[e],o=t[e+1],s=t[e+2],a=t[e+3];i[r]=(255-n)/256*255*((255-a)/256),i[r+1]=(255-o)/256*255*((255-a)/256),i[r+2]=(255-s)/256*255*((255-a)/256)}return i}function b(t){const{width:e,height:r}=t,i=new Uint8ClampedArray(e*r*3);for(let e=0,r=0;e<t.length;e+=3,r+=3){const n=t[e],o=t[e+1],s=t[e+2];i[r]=n+1.402*(s-128),i[r+1]=n-.34414*(o-128)-.71414*(s-128),i[r+2]=n+1.772*(o-128)}return i}function S(t){const{width:e,height:r}=t,i=new Uint8Array(e*r*3);for(let e=0,r=0;e<t.length;e+=3,r+=3){let n,o,s,a=(t[e+0]+16)/116,h=(t[e+1]<<24>>24)/500+a,l=a-(t[e+2]<<24>>24)/200;h=.95047*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),a=1*(a*a*a>.008856?a*a*a:(a-16/116)/7.787),l=1.08883*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),n=3.2406*h+-1.5372*a+-.4986*l,o=-.9689*h+1.8758*a+.0415*l,s=.0557*h+-.204*a+1.057*l,n=n>.0031308?1.055*n**(1/2.4)-.055:12.92*n,o=o>.0031308?1.055*o**(1/2.4)-.055:12.92*o,s=s>.0031308?1.055*s**(1/2.4)-.055:12.92*s,i[r]=255*Math.max(0,Math.min(1,n)),i[r+1]=255*Math.max(0,Math.min(1,o)),i[r+2]=255*Math.max(0,Math.min(1,s))}return i}var A=Object.freeze({__proto__:null,fromWhiteIsZero:d,fromBlackIsZero:w,fromPalette:y,fromCMYK:m,fromYCbCr:b,fromCIELab:S});const T=new Map;function E(t,e){Array.isArray(t)||(t=[t]),t.forEach((t=>T.set(t,e)))}async function I(t){const e=T.get(t.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${t.Compression}`);return new(await e())(t)}function P(t,e,r,i=1){return new(Object.getPrototypeOf(t).constructor)(e*r*i)}function R(t,e,r){return(1-r)*t+r*e}function D(t,e,r,i,n,o="nearest"){switch(o.toLowerCase()){case"nearest":return function(t,e,r,i,n){const o=e/i,s=r/n;return t.map((t=>{const a=P(t,i,n);for(let h=0;h<n;++h){const n=Math.min(Math.round(s*h),r-1);for(let r=0;r<i;++r){const s=Math.min(Math.round(o*r),e-1),l=t[n*e+s];a[h*i+r]=l}}return a}))}(t,e,r,i,n);case"bilinear":case"linear":return function(t,e,r,i,n){const o=e/i,s=r/n;return t.map((t=>{const a=P(t,i,n);for(let h=0;h<n;++h){const n=s*h,l=Math.floor(n),f=Math.min(Math.ceil(n),r-1);for(let r=0;r<i;++r){const s=o*r,c=s%1,u=Math.floor(s),g=Math.min(Math.ceil(s),e-1),p=t[l*e+u],d=t[l*e+g],w=t[f*e+u],y=t[f*e+g],m=R(R(p,d,c),R(w,y,c),n%1);a[h*i+r]=m}}return a}))}(t,e,r,i,n);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function U(t,e,r,i,n,o,s="nearest"){switch(s.toLowerCase()){case"nearest":return function(t,e,r,i,n,o){const s=e/i,a=r/n,h=P(t,i,n,o);for(let l=0;l<n;++l){const n=Math.min(Math.round(a*l),r-1);for(let r=0;r<i;++r){const a=Math.min(Math.round(s*r),e-1);for(let s=0;s<o;++s){const f=t[n*e*o+a*o+s];h[l*i*o+r*o+s]=f}}}return h}(t,e,r,i,n,o);case"bilinear":case"linear":return function(t,e,r,i,n,o){const s=e/i,a=r/n,h=P(t,i,n,o);for(let l=0;l<n;++l){const n=a*l,f=Math.floor(n),c=Math.min(Math.ceil(n),r-1);for(let r=0;r<i;++r){const a=s*r,u=a%1,g=Math.floor(a),p=Math.min(Math.ceil(a),e-1);for(let s=0;s<o;++s){const a=t[f*e*o+g*o+s],d=t[f*e*o+p*o+s],w=t[c*e*o+g*o+s],y=t[c*e*o+p*o+s],m=R(R(a,d,u),R(w,y,u),n%1);h[l*i*o+r*o+s]=m}}}return h}(t,e,r,i,n,o);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function O(t,e,r){let i=0;for(let n=e;n<r;++n)i+=t[n];return i}function v(t,e,r){switch(t){case 1:if(e<=8)return new Uint8Array(r);if(e<=16)return new Uint16Array(r);if(e<=32)return new Uint32Array(r);break;case 2:if(8===e)return new Int8Array(r);if(16===e)return new Int16Array(r);if(32===e)return new Int32Array(r);break;case 3:switch(e){case 16:case 32:return new Float32Array(r);case 64:return new Float64Array(r)}}throw Error("Unsupported data format/bitsPerSample")}E([void 0,1],(()=>import("./dist-module/compression/raw.js._esm.js").then((t=>t.default)))),E(5,(()=>import("./dist-module/compression/lzw.js._esm.js").then((t=>t.default)))),E(6,(()=>{throw new Error("old style JPEG compression is not supported.")})),E(7,(()=>import("./dist-module/compression/jpeg.js._esm.js").then((t=>t.default)))),E([8,32946],(()=>import("./dist-module/compression/deflate.js._esm.js").then((t=>t.default)))),E(32773,(()=>import("./dist-module/compression/packbits.js._esm.js").then((t=>t.default)))),E(34887,(()=>import("./dist-module/compression/lerc.js._esm.js").then((async t=>(await t.zstd.init(),t))).then((t=>t.default)))),E(50001,(()=>import("./dist-module/compression/webimage.js._esm.js").then((t=>t.default))));class C{constructor(t,e,r,i,n,o){this.fileDirectory=t,this.geoKeys=e,this.dataView=r,this.littleEndian=i,this.tiles=n?{}:null,this.isTiled=!t.StripOffsets;const s=t.PlanarConfiguration;if(this.planarConfiguration=void 0===s?1:s,1!==this.planarConfiguration&&2!==this.planarConfiguration)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return void 0!==this.fileDirectory.SamplesPerPixel?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:void 0!==this.fileDirectory.RowsPerStrip?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(t){return this.isTiled||(t+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-t*this.getTileHeight()}getBytesPerPixel(){let t=0;for(let e=0;e<this.fileDirectory.BitsPerSample.length;++e)t+=this.getSampleByteSize(e);return t}getSampleByteSize(t){if(t>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${t} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[t]/8)}getReaderForSample(e){const r=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,i=this.fileDirectory.BitsPerSample[e];switch(r){case 1:if(i<=8)return DataView.prototype.getUint8;if(i<=16)return DataView.prototype.getUint16;if(i<=32)return DataView.prototype.getUint32;break;case 2:if(i<=8)return DataView.prototype.getInt8;if(i<=16)return DataView.prototype.getInt16;if(i<=32)return DataView.prototype.getInt32;break;case 3:switch(i){case 16:return function(e,r){return t(this,e,r)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(t=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1}getBitsPerSample(t=0){return this.fileDirectory.BitsPerSample[t]}getArrayForSample(t,e){return v(this.getSampleFormat(t),this.getBitsPerSample(t),e)}async getTileOrStrip(t,e,r,i,n){const o=Math.ceil(this.getWidth()/this.getTileWidth()),s=Math.ceil(this.getHeight()/this.getTileHeight());let a;const{tiles:h}=this;let l,f;1===this.planarConfiguration?a=e*o+t:2===this.planarConfiguration&&(a=r*o*s+e*o+t),this.isTiled?(l=this.fileDirectory.TileOffsets[a],f=this.fileDirectory.TileByteCounts[a]):(l=this.fileDirectory.StripOffsets[a],f=this.fileDirectory.StripByteCounts[a]);const c=(await this.source.fetch([{offset:l,length:f}],n))[0];let u;return null!==h&&h[a]?u=h[a]:(u=(async()=>{let t=await i.decode(this.fileDirectory,c);const r=this.getSampleFormat(),n=this.getBitsPerSample();return function(t,e){return(1!==t&&2!==t||!(e<=32)||e%8!=0)&&(3!==t||16!==e&&32!==e&&64!==e)}(r,n)&&(t=function(t,e,r,i,n,o,s){const a=new DataView(t),h=2===r?1:i,l=v(e,n,2===r?s*o:s*o*i),f=parseInt("1".repeat(n),2);if(1===e){let t;t=1===r?i*n:n;let e=o*t;0!=(7&e)&&(e=e+7&-8);for(let t=0;t<s;++t){const r=t*e;for(let e=0;e<o;++e){const i=r+e*h*n;for(let r=0;r<h;++r){const s=i+r*n,c=(t*o+e)*h+r,u=Math.floor(s/8),g=s%8;if(g+n<=8)l[c]=a.getUint8(u)>>8-n-g&f;else if(g+n<=16)l[c]=a.getUint16(u)>>16-n-g&f;else if(g+n<=24){const t=a.getUint16(u)<<8|a.getUint8(u+2);l[c]=t>>24-n-g&f}else l[c]=a.getUint32(u)>>32-n-g&f}}}}return l.buffer}(t,r,this.planarConfiguration,this.getSamplesPerPixel(),n,this.getTileWidth(),this.getBlockHeight(e))),t})(),null!==h&&(h[a]=u)),{x:t,y:e,sample:r,data:await u}}async _readRaster(t,e,r,i,n,o,s,a,h){const l=this.getTileWidth(),f=this.getTileHeight(),c=this.getWidth(),u=this.getHeight(),g=Math.max(Math.floor(t[0]/l),0),p=Math.min(Math.ceil(t[2]/l),Math.ceil(c/l)),d=Math.max(Math.floor(t[1]/f),0),w=Math.min(Math.ceil(t[3]/f),Math.ceil(u/f)),y=t[2]-t[0];let m=this.getBytesPerPixel();const b=[],S=[];for(let t=0;t<e.length;++t)1===this.planarConfiguration?b.push(O(this.fileDirectory.BitsPerSample,0,e[t])/8):b.push(0),S.push(this.getReaderForSample(e[t]));const A=[],{littleEndian:T}=this;for(let o=d;o<w;++o)for(let s=g;s<p;++s){let a;1===this.planarConfiguration&&(a=this.getTileOrStrip(s,o,0,n,h));for(let g=0;g<e.length;++g){const p=g,d=e[g];2===this.planarConfiguration&&(m=this.getSampleByteSize(d),a=this.getTileOrStrip(s,o,d,n,h));const w=a.then((n=>{const o=n.data,s=new DataView(o),a=this.getBlockHeight(n.y),h=n.y*f,g=n.x*l,d=h+a,w=(n.x+1)*l,A=S[p],E=Math.min(a,a-(d-t[3]),u-h),I=Math.min(l,l-(w-t[2]),c-g);for(let n=Math.max(0,t[1]-h);n<E;++n)for(let o=Math.max(0,t[0]-g);o<I;++o){const a=(n*l+o)*m,f=A.call(s,a+b[p],T);let c;i?(c=(n+h-t[1])*y*e.length+(o+g-t[0])*e.length+p,r[c]=f):(c=(n+h-t[1])*y+o+g-t[0],r[p][c]=f)}}));A.push(w)}}if(await Promise.all(A),o&&t[2]-t[0]!==o||s&&t[3]-t[1]!==s){let n;return n=i?U(r,t[2]-t[0],t[3]-t[1],o,s,e.length,a):D(r,t[2]-t[0],t[3]-t[1],o,s,a),n.width=o,n.height=s,n}return r.width=o||t[2]-t[0],r.height=s||t[3]-t[1],r}async readRasters({window:t,samples:e=[],interleave:r,pool:i=null,width:n,height:o,resampleMethod:s,fillValue:a,signal:h}={}){const l=t||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const f=(l[2]-l[0])*(l[3]-l[1]),c=this.getSamplesPerPixel();if(e&&e.length){for(let t=0;t<e.length;++t)if(e[t]>=c)return Promise.reject(new RangeError(`Invalid sample index '${e[t]}'.`))}else for(let t=0;t<c;++t)e.push(t);let u;if(r){u=v(this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,Math.max.apply(null,this.fileDirectory.BitsPerSample),f*e.length),a&&u.fill(a)}else{u=[];for(let t=0;t<e.length;++t){const r=this.getArrayForSample(e[t],f);Array.isArray(a)&&t<a.length?r.fill(a[t]):a&&!Array.isArray(a)&&r.fill(a),u.push(r)}}const g=i||await I(this.fileDirectory);return await this._readRaster(l,e,u,r,g,n,o,s,h)}async readRGB({window:t,interleave:e=!0,pool:r=null,width:i,height:n,resampleMethod:o,enableAlpha:s=!1,signal:a}={}){const h=t||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");const l=this.fileDirectory.PhotometricInterpretation;if(l===f.RGB){let h=[0,1,2];if(this.fileDirectory.ExtraSamples!==c.Unspecified&&s){h=[];for(let t=0;t<this.fileDirectory.BitsPerSample.length;t+=1)h.push(t)}return this.readRasters({window:t,interleave:e,samples:h,pool:r,width:i,height:n,resampleMethod:o,signal:a})}let u;switch(l){case f.WhiteIsZero:case f.BlackIsZero:case f.Palette:u=[0];break;case f.CMYK:u=[0,1,2,3];break;case f.YCbCr:case f.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const g={window:h,interleave:!0,samples:u,pool:r,width:i,height:n,resampleMethod:o,signal:a},{fileDirectory:p}=this,A=await this.readRasters(g),T=2**this.fileDirectory.BitsPerSample[0];let E;switch(l){case f.WhiteIsZero:E=d(A,T);break;case f.BlackIsZero:E=w(A,T);break;case f.Palette:E=y(A,p.ColorMap);break;case f.CMYK:E=m(A);break;case f.YCbCr:E=b(A);break;case f.CIELab:E=S(A);break;default:throw new Error("Unsupported photometric interpretation.")}if(!e){const t=new Uint8Array(E.length/3),e=new Uint8Array(E.length/3),r=new Uint8Array(E.length/3);for(let i=0,n=0;i<E.length;i+=3,++n)t[n]=E[i],e[n]=E[i+1],r[n]=E[i+2];E=[t,e,r]}return E.width=A.width,E.height=A.height,E}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const t=[];for(let e=0;e<this.fileDirectory.ModelTiepoint.length;e+=6)t.push({i:this.fileDirectory.ModelTiepoint[e],j:this.fileDirectory.ModelTiepoint[e+1],k:this.fileDirectory.ModelTiepoint[e+2],x:this.fileDirectory.ModelTiepoint[e+3],y:this.fileDirectory.ModelTiepoint[e+4],z:this.fileDirectory.ModelTiepoint[e+5]});return t}getGDALMetadata(t=null){const i={};if(!this.fileDirectory.GDAL_METADATA)return null;const n=this.fileDirectory.GDAL_METADATA;let o=r(n,"Item");o=null===t?o.filter((t=>void 0===e(t,"sample"))):o.filter((r=>Number(e(r,"sample"))===t));for(let t=0;t<o.length;++t){const r=o[t];i[e(r,"name")]=r.inner}return i}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const t=this.fileDirectory.GDAL_NODATA;return Number(t.substring(0,t.length-1))}getOrigin(){const t=this.fileDirectory.ModelTiepoint,e=this.fileDirectory.ModelTransformation;if(t&&6===t.length)return[t[3],t[4],t[5]];if(e)return[e[3],e[7],e[11]];throw new Error("The image does not have an affine transformation.")}getResolution(t=null){const e=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(e)return[e[0],-e[1],e[2]];if(r)return 0===r[1]&&0===r[4]?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(t){const[e,r,i]=t.getResolution();return[e*t.getWidth()/this.getWidth(),r*t.getHeight()/this.getHeight(),i*t.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return 1===this.geoKeys.GTRasterTypeGeoKey}getBoundingBox(t=!1){const e=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!t){const[t,i,n,o,s,a,h,l]=this.fileDirectory.ModelTransformation,f=[[0,0],[0,e],[r,0],[r,e]].map((([e,r])=>[o+t*e+i*r,l+s*e+a*r])),c=f.map((t=>t[0])),u=f.map((t=>t[1]));return[Math.min(...c),Math.min(...u),Math.max(...c),Math.max(...u)]}{const t=this.getOrigin(),i=this.getResolution(),n=t[0],o=t[1],s=n+i[0]*r,a=o+i[1]*e;return[Math.min(n,s),Math.min(o,a),Math.max(n,s),Math.max(o,a)]}}}class M{constructor(t){this._dataView=new DataView(t)}get buffer(){return this._dataView.buffer}getUint64(t,e){const r=this.getUint32(t,e),i=this.getUint32(t+4,e);let n;if(e){if(n=r+2**32*i,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*r+i,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}getInt64(t,e){let r=0;const i=(128&this._dataView.getUint8(t+(e?7:0)))>0;let n=!0;for(let o=0;o<8;o++){let s=this._dataView.getUint8(t+(e?o:7-o));i&&(n?0!==s&&(s=255&~(s-1),n=!1):s=255&~s),r+=s*256**o}return i&&(r=-r),r}getUint8(t,e){return this._dataView.getUint8(t,e)}getInt8(t,e){return this._dataView.getInt8(t,e)}getUint16(t,e){return this._dataView.getUint16(t,e)}getInt16(t,e){return this._dataView.getInt16(t,e)}getUint32(t,e){return this._dataView.getUint32(t,e)}getInt32(t,e){return this._dataView.getInt32(t,e)}getFloat16(e,r){return t(this._dataView,e,r)}getFloat32(t,e){return this._dataView.getFloat32(t,e)}getFloat64(t,e){return this._dataView.getFloat64(t,e)}}class _{constructor(t,e,r,i){this._dataView=new DataView(t),this._sliceOffset=e,this._littleEndian=r,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(t,e){return this.sliceOffset<=t&&this.sliceTop>=t+e}readUint8(t){return this._dataView.getUint8(t-this._sliceOffset,this._littleEndian)}readInt8(t){return this._dataView.getInt8(t-this._sliceOffset,this._littleEndian)}readUint16(t){return this._dataView.getUint16(t-this._sliceOffset,this._littleEndian)}readInt16(t){return this._dataView.getInt16(t-this._sliceOffset,this._littleEndian)}readUint32(t){return this._dataView.getUint32(t-this._sliceOffset,this._littleEndian)}readInt32(t){return this._dataView.getInt32(t-this._sliceOffset,this._littleEndian)}readFloat32(t){return this._dataView.getFloat32(t-this._sliceOffset,this._littleEndian)}readFloat64(t){return this._dataView.getFloat64(t-this._sliceOffset,this._littleEndian)}readUint64(t){const e=this.readUint32(t),r=this.readUint32(t+4);let i;if(this._littleEndian){if(i=e+2**32*r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*e+r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(t){let e=0;const r=(128&this._dataView.getUint8(t+(this._littleEndian?7:0)))>0;let i=!0;for(let n=0;n<8;n++){let o=this._dataView.getUint8(t+(this._littleEndian?n:7-n));r&&(i?0!==o&&(o=255&~(o-1),i=!1):o=255&~o),e+=o*256**n}return r&&(e=-e),e}readOffset(t){return this._bigTiff?this.readUint64(t):this.readUint32(t)}}const G="undefined"!=typeof navigator&&navigator.hardwareConcurrency||2;class k{constructor(t=G,e){this.workers=null,this._awaitingDecoder=null,this.size=t,this.messageId=0,t&&(this._awaitingDecoder=e?Promise.resolve(e):new Promise((t=>{import("./dist-module/worker/decoder.js._esm.js").then((e=>{t(e.create)}))})),this._awaitingDecoder.then((e=>{this._awaitingDecoder=null,this.workers=[];for(let r=0;r<t;r++)this.workers.push({worker:e(),idle:!0})})))}async decode(t,e){return this._awaitingDecoder&&await this._awaitingDecoder,0===this.size?I(t).then((r=>r.decode(t,e))):new Promise((r=>{const i=this.workers.find((t=>t.idle))||this.workers[Math.floor(Math.random()*this.size)];i.idle=!1;const n=this.messageId++,o=t=>{t.data.id===n&&(i.idle=!0,r(t.data.decoded),i.worker.removeEventListener("message",o))};i.worker.addEventListener("message",o),i.worker.postMessage({fileDirectory:t,buffer:e,id:n},[e])}))}destroy(){this.workers&&(this.workers.forEach((t=>{t.worker.terminate()})),this.workers=null)}}const F="\r\n\r\n";function B(t){if(void 0!==Object.fromEntries)return Object.fromEntries(t);const e={};for(const[r,i]of t)e[r.toLowerCase()]=i;return e}function L(t){return B(t.split("\r\n").map((t=>{const e=t.split(":").map((t=>t.trim()));return e[0]=e[0].toLowerCase(),e})))}function x(t){let e,r,i;return t&&([,e,r,i]=t.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),r=parseInt(r,10),i=parseInt(i,10)),{start:e,end:r,total:i}}class N{async fetch(t,e=void 0){return Promise.all(t.map((t=>this.fetchSlice(t,e))))}async fetchSlice(t){throw new Error(`fetching of slice ${t} not possible, not implemented`)}get fileSize(){return null}async close(){}}function K(t,e){for(const r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}function Y(t,e){if(t.length<e.length)return!1;return t.substr(t.length-e.length)===e}function j(t){const e={};for(const r in t)if(t.hasOwnProperty(r)){e[t[r]]=r}return e}function V(t,e){const r=[];for(let i=0;i<t;i++)r.push(e(i));return r}class z extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,z),this.name="AbortError"}}class H extends Error{constructor(t,e){super(e),this.errors=t,this.message=e,this.name="AggregateError"}}const q=H;class W{constructor(t,e,r=null){this.offset=t,this.length=e,this.data=r}get top(){return this.offset+this.length}}class ${constructor(t,e,r){this.offset=t,this.length=e,this.blockIds=r}}class X extends N{constructor(t,{blockSize:e=65536,cacheSize:r=100}={}){super(),this.source=t,this.blockSize=e,this.blockCache=new i({maxSize:r,onEviction:(t,e)=>{this.evictedBlocks.set(t,e)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(t,e){const r=[],i=[],n=[];this.evictedBlocks.clear();for(const{offset:e,length:o}of t){let t=e+o;const{fileSize:s}=this;null!==s&&(t=Math.min(t,s));for(let o=Math.floor(e/this.blockSize)*this.blockSize;o<t;o+=this.blockSize){const t=Math.floor(o/this.blockSize);this.blockCache.has(t)||this.blockRequests.has(t)||(this.blockIdsToFetch.add(t),i.push(t)),this.blockRequests.has(t)&&r.push(this.blockRequests.get(t)),n.push(t)}}await async function(t){return new Promise((e=>setTimeout(e,t)))}(),this.fetchBlocks(e);const o=[];for(const t of i)this.blockRequests.has(t)&&o.push(this.blockRequests.get(t));await Promise.allSettled(r),await Promise.allSettled(o);const s=[],a=n.filter((t=>this.abortedBlockIds.has(t)||!this.blockCache.has(t)));if(a.forEach((t=>this.blockIdsToFetch.add(t))),a.length>0&&e&&!e.aborted){this.fetchBlocks(null);for(const t of a){const e=this.blockRequests.get(t);if(!e)throw new Error(`Block ${t} is not in the block requests`);s.push(e)}await Promise.allSettled(s)}if(e&&e.aborted)throw new z("Request was aborted");const h=n.map((t=>this.blockCache.get(t)||this.evictedBlocks.get(t))),l=h.filter((t=>!t));if(l.length)throw new q(l,"Request failed");const f=new Map(function(t,e){const r=Array.isArray(t)?t:Array.from(t),i=Array.isArray(e)?e:Array.from(e);return r.map(((t,e)=>[t,i[e]]))}(n,h));return this.readSliceData(t,f)}fetchBlocks(t){if(this.blockIdsToFetch.size>0){const e=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(e,t);for(let i=0;i<e.length;++i){const n=e[i];for(const e of n.blockIds)this.blockRequests.set(e,(async()=>{try{const t=(await r)[i],n=e*this.blockSize,o=n-t.offset,s=Math.min(o+this.blockSize,t.data.byteLength),a=t.data.slice(o,s),h=new W(n,a.byteLength,a,e);this.blockCache.set(e,h),this.abortedBlockIds.delete(e)}catch(r){if("AbortError"!==r.name)throw r;r.signal=t,this.blockCache.delete(e),this.abortedBlockIds.add(e)}finally{this.blockRequests.delete(e)}})())}this.blockIdsToFetch.clear()}}groupBlocks(t){const e=Array.from(t).sort(((t,e)=>t-e));if(0===e.length)return[];let r=[],i=null;const n=[];for(const t of e)null===i||i+1===t?(r.push(t),i=t):(n.push(new $(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[t],i=t);return n.push(new $(r[0]*this.blockSize,r.length*this.blockSize,r)),n}readSliceData(t,e){return t.map((t=>{let r=t.offset+t.length;null!==this.fileSize&&(r=Math.min(this.fileSize,r));const i=Math.floor(t.offset/this.blockSize),n=Math.floor(r/this.blockSize),o=new ArrayBuffer(t.length),s=new Uint8Array(o);for(let o=i;o<=n;++o){const i=e.get(o),n=i.offset-t.offset;let a,h=0,l=0;n<0?h=-n:n>0&&(l=n),a=i.top-r<0?i.length-h:r-i.offset-h;const f=new Uint8Array(i.data,h,a);s.set(f,l)}return o}))}}class Z{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(t){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class J{constructor(t){this.url=t}async request({headers:t,signal:e}={}){throw new Error("request is not implemented")}}class Q extends Z{constructor(t){super(),this.response=t}get status(){return this.response.status}getHeader(t){return this.response.headers.get(t)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class tt extends J{constructor(t,e){super(t),this.credentials=e}async request({headers:t,signal:e}={}){const r=await fetch(this.url,{headers:t,credentials:this.credentials,signal:e});return new Q(r)}}class et extends Z{constructor(t,e){super(),this.xhr=t,this.data=e}get status(){return this.xhr.status}getHeader(t){return this.xhr.getResponseHeader(t)}async getData(){return this.data}}class rt extends J{constructRequest(t,e){return new Promise(((r,i)=>{const n=new XMLHttpRequest;n.open("GET",this.url),n.responseType="arraybuffer";for(const[e,r]of Object.entries(t))n.setRequestHeader(e,r);n.onload=()=>{const t=n.response;r(new et(n,t))},n.onerror=i,n.onabort=()=>i(new z("Request aborted")),n.send(),e&&(e.aborted&&n.abort(),e.addEventListener("abort",(()=>n.abort())))}))}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}var it="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},nt=[],ot=[],st="undefined"!=typeof Uint8Array?Uint8Array:Array,at=!1;function ht(){at=!0;for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=0;e<64;++e)nt[e]=t[e],ot[t.charCodeAt(e)]=e;ot["-".charCodeAt(0)]=62,ot["_".charCodeAt(0)]=63}function lt(t,e,r){for(var i,n,o=[],s=e;s<r;s+=3)i=(t[s]<<16)+(t[s+1]<<8)+t[s+2],o.push(nt[(n=i)>>18&63]+nt[n>>12&63]+nt[n>>6&63]+nt[63&n]);return o.join("")}function ft(t){var e;at||ht();for(var r=t.length,i=r%3,n="",o=[],s=16383,a=0,h=r-i;a<h;a+=s)o.push(lt(t,a,a+s>h?h:a+s));return 1===i?(e=t[r-1],n+=nt[e>>2],n+=nt[e<<4&63],n+="=="):2===i&&(e=(t[r-2]<<8)+t[r-1],n+=nt[e>>10],n+=nt[e>>4&63],n+=nt[e<<2&63],n+="="),o.push(n),o.join("")}function ct(t,e,r,i,n){var o,s,a=8*n-i-1,h=(1<<a)-1,l=h>>1,f=-7,c=r?n-1:0,u=r?-1:1,g=t[e+c];for(c+=u,o=g&(1<<-f)-1,g>>=-f,f+=a;f>0;o=256*o+t[e+c],c+=u,f-=8);for(s=o&(1<<-f)-1,o>>=-f,f+=i;f>0;s=256*s+t[e+c],c+=u,f-=8);if(0===o)o=1-l;else{if(o===h)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,i),o-=l}return(g?-1:1)*s*Math.pow(2,o-i)}function ut(t,e,r,i,n,o){var s,a,h,l=8*o-n-1,f=(1<<l)-1,c=f>>1,u=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,g=i?0:o-1,p=i?1:-1,d=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=f):(s=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-s))<1&&(s--,h*=2),(e+=s+c>=1?u/h:u*Math.pow(2,1-c))*h>=2&&(s++,h/=2),s+c>=f?(a=0,s=f):s+c>=1?(a=(e*h-1)*Math.pow(2,n),s+=c):(a=e*Math.pow(2,c-1)*Math.pow(2,n),s=0));n>=8;t[r+g]=255&a,g+=p,a/=256,n-=8);for(s=s<<n|a,l+=n;l>0;t[r+g]=255&s,g+=p,s/=256,l-=8);t[r+g-p]|=128*d}var gt={}.toString,pt=Array.isArray||function(t){return"[object Array]"==gt.call(t)};function dt(){return yt.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function wt(t,e){if(dt()<e)throw new RangeError("Invalid typed array length");return yt.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=yt.prototype:(null===t&&(t=new yt(e)),t.length=e),t}function yt(t,e,r){if(!(yt.TYPED_ARRAY_SUPPORT||this instanceof yt))return new yt(t,e,r);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return St(this,t)}return mt(this,t,e,r)}function mt(t,e,r,i){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,r,i){if(e.byteLength,r<0||e.byteLength<r)throw new RangeError("'offset' is out of bounds");if(e.byteLength<r+(i||0))throw new RangeError("'length' is out of bounds");e=void 0===r&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,r):new Uint8Array(e,r,i);yt.TYPED_ARRAY_SUPPORT?(t=e).__proto__=yt.prototype:t=At(t,e);return t}(t,e,r,i):"string"==typeof e?function(t,e,r){"string"==typeof r&&""!==r||(r="utf8");if(!yt.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var i=0|It(e,r);t=wt(t,i);var n=t.write(e,r);n!==i&&(t=t.slice(0,n));return t}(t,e,r):function(t,e){if(Et(e)){var r=0|Tt(e.length);return 0===(t=wt(t,r)).length||e.copy(t,0,0,r),t}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||(i=e.length)!=i?wt(t,0):At(t,e);if("Buffer"===e.type&&pt(e.data))return At(t,e.data)}var i;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function bt(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function St(t,e){if(bt(e),t=wt(t,e<0?0:0|Tt(e)),!yt.TYPED_ARRAY_SUPPORT)for(var r=0;r<e;++r)t[r]=0;return t}function At(t,e){var r=e.length<0?0:0|Tt(e.length);t=wt(t,r);for(var i=0;i<r;i+=1)t[i]=255&e[i];return t}function Tt(t){if(t>=dt())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+dt().toString(16)+" bytes");return 0|t}function Et(t){return!(null==t||!t._isBuffer)}function It(t,e){if(Et(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var r=t.length;if(0===r)return 0;for(var i=!1;;)switch(e){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return Zt(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return Jt(t).length;default:if(i)return Zt(t).length;e=(""+e).toLowerCase(),i=!0}}function Pt(t,e,r){var i=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return Nt(this,e,r);case"utf8":case"utf-8":return Ft(this,e,r);case"ascii":return Lt(this,e,r);case"latin1":case"binary":return xt(this,e,r);case"base64":return kt(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Kt(this,e,r);default:if(i)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),i=!0}}function Rt(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function Dt(t,e,r,i,n){if(0===t.length)return-1;if("string"==typeof r?(i=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=n?0:t.length-1),r<0&&(r=t.length+r),r>=t.length){if(n)return-1;r=t.length-1}else if(r<0){if(!n)return-1;r=0}if("string"==typeof e&&(e=yt.from(e,i)),Et(e))return 0===e.length?-1:Ut(t,e,r,i,n);if("number"==typeof e)return e&=255,yt.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(t,e,r):Uint8Array.prototype.lastIndexOf.call(t,e,r):Ut(t,[e],r,i,n);throw new TypeError("val must be string, number or Buffer")}function Ut(t,e,r,i,n){var o,s=1,a=t.length,h=e.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(t.length<2||e.length<2)return-1;s=2,a/=2,h/=2,r/=2}function l(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(n){var f=-1;for(o=r;o<a;o++)if(l(t,o)===l(e,-1===f?0:o-f)){if(-1===f&&(f=o),o-f+1===h)return f*s}else-1!==f&&(o-=o-f),f=-1}else for(r+h>a&&(r=a-h),o=r;o>=0;o--){for(var c=!0,u=0;u<h;u++)if(l(t,o+u)!==l(e,u)){c=!1;break}if(c)return o}return-1}function Ot(t,e,r,i){r=Number(r)||0;var n=t.length-r;i?(i=Number(i))>n&&(i=n):i=n;var o=e.length;if(o%2!=0)throw new TypeError("Invalid hex string");i>o/2&&(i=o/2);for(var s=0;s<i;++s){var a=parseInt(e.substr(2*s,2),16);if(isNaN(a))return s;t[r+s]=a}return s}function vt(t,e,r,i){return Qt(Zt(e,t.length-r),t,r,i)}function Ct(t,e,r,i){return Qt(function(t){for(var e=[],r=0;r<t.length;++r)e.push(255&t.charCodeAt(r));return e}(e),t,r,i)}function Mt(t,e,r,i){return Ct(t,e,r,i)}function _t(t,e,r,i){return Qt(Jt(e),t,r,i)}function Gt(t,e,r,i){return Qt(function(t,e){for(var r,i,n,o=[],s=0;s<t.length&&!((e-=2)<0);++s)i=(r=t.charCodeAt(s))>>8,n=r%256,o.push(n),o.push(i);return o}(e,t.length-r),t,r,i)}function kt(t,e,r){return 0===e&&r===t.length?ft(t):ft(t.slice(e,r))}function Ft(t,e,r){r=Math.min(t.length,r);for(var i=[],n=e;n<r;){var o,s,a,h,l=t[n],f=null,c=l>239?4:l>223?3:l>191?2:1;if(n+c<=r)switch(c){case 1:l<128&&(f=l);break;case 2:128==(192&(o=t[n+1]))&&(h=(31&l)<<6|63&o)>127&&(f=h);break;case 3:o=t[n+1],s=t[n+2],128==(192&o)&&128==(192&s)&&(h=(15&l)<<12|(63&o)<<6|63&s)>2047&&(h<55296||h>57343)&&(f=h);break;case 4:o=t[n+1],s=t[n+2],a=t[n+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(h=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&h<1114112&&(f=h)}null===f?(f=65533,c=1):f>65535&&(f-=65536,i.push(f>>>10&1023|55296),f=56320|1023&f),i.push(f),n+=c}return function(t){var e=t.length;if(e<=Bt)return String.fromCharCode.apply(String,t);var r="",i=0;for(;i<e;)r+=String.fromCharCode.apply(String,t.slice(i,i+=Bt));return r}(i)}yt.TYPED_ARRAY_SUPPORT=void 0===it.TYPED_ARRAY_SUPPORT||it.TYPED_ARRAY_SUPPORT,dt(),yt.poolSize=8192,yt._augment=function(t){return t.__proto__=yt.prototype,t},yt.from=function(t,e,r){return mt(null,t,e,r)},yt.TYPED_ARRAY_SUPPORT&&(yt.prototype.__proto__=Uint8Array.prototype,yt.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&yt[Symbol.species]),yt.alloc=function(t,e,r){return function(t,e,r,i){return bt(e),e<=0?wt(t,e):void 0!==r?"string"==typeof i?wt(t,e).fill(r,i):wt(t,e).fill(r):wt(t,e)}(null,t,e,r)},yt.allocUnsafe=function(t){return St(null,t)},yt.allocUnsafeSlow=function(t){return St(null,t)},yt.isBuffer=function(t){return null!=t&&(!!t._isBuffer||te(t)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&te(t.slice(0,0))}(t))},yt.compare=function(t,e){if(!Et(t)||!Et(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var r=t.length,i=e.length,n=0,o=Math.min(r,i);n<o;++n)if(t[n]!==e[n]){r=t[n],i=e[n];break}return r<i?-1:i<r?1:0},yt.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},yt.concat=function(t,e){if(!pt(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return yt.alloc(0);var r;if(void 0===e)for(e=0,r=0;r<t.length;++r)e+=t[r].length;var i=yt.allocUnsafe(e),n=0;for(r=0;r<t.length;++r){var o=t[r];if(!Et(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(i,n),n+=o.length}return i},yt.byteLength=It,yt.prototype._isBuffer=!0,yt.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)Rt(this,e,e+1);return this},yt.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)Rt(this,e,e+3),Rt(this,e+1,e+2);return this},yt.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)Rt(this,e,e+7),Rt(this,e+1,e+6),Rt(this,e+2,e+5),Rt(this,e+3,e+4);return this},yt.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?Ft(this,0,t):Pt.apply(this,arguments)},yt.prototype.equals=function(t){if(!Et(t))throw new TypeError("Argument must be a Buffer");return this===t||0===yt.compare(this,t)},yt.prototype.inspect=function(){var t="";return this.length>0&&(t=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(t+=" ... ")),"<Buffer "+t+">"},yt.prototype.compare=function(t,e,r,i,n){if(!Et(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===r&&(r=t?t.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),e<0||r>t.length||i<0||n>this.length)throw new RangeError("out of range index");if(i>=n&&e>=r)return 0;if(i>=n)return-1;if(e>=r)return 1;if(this===t)return 0;for(var o=(n>>>=0)-(i>>>=0),s=(r>>>=0)-(e>>>=0),a=Math.min(o,s),h=this.slice(i,n),l=t.slice(e,r),f=0;f<a;++f)if(h[f]!==l[f]){o=h[f],s=l[f];break}return o<s?-1:s<o?1:0},yt.prototype.includes=function(t,e,r){return-1!==this.indexOf(t,e,r)},yt.prototype.indexOf=function(t,e,r){return Dt(this,t,e,r,!0)},yt.prototype.lastIndexOf=function(t,e,r){return Dt(this,t,e,r,!1)},yt.prototype.write=function(t,e,r,i){if(void 0===e)i="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)i=e,r=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(r)?(r|=0,void 0===i&&(i="utf8")):(i=r,r=void 0)}var n=this.length-e;if((void 0===r||r>n)&&(r=n),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");for(var o=!1;;)switch(i){case"hex":return Ot(this,t,e,r);case"utf8":case"utf-8":return vt(this,t,e,r);case"ascii":return Ct(this,t,e,r);case"latin1":case"binary":return Mt(this,t,e,r);case"base64":return _t(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Gt(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),o=!0}},yt.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Bt=4096;function Lt(t,e,r){var i="";r=Math.min(t.length,r);for(var n=e;n<r;++n)i+=String.fromCharCode(127&t[n]);return i}function xt(t,e,r){var i="";r=Math.min(t.length,r);for(var n=e;n<r;++n)i+=String.fromCharCode(t[n]);return i}function Nt(t,e,r){var i=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>i)&&(r=i);for(var n="",o=e;o<r;++o)n+=Xt(t[o]);return n}function Kt(t,e,r){for(var i=t.slice(e,r),n="",o=0;o<i.length;o+=2)n+=String.fromCharCode(i[o]+256*i[o+1]);return n}function Yt(t,e,r){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function jt(t,e,r,i,n,o){if(!Et(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<o)throw new RangeError('"value" argument is out of bounds');if(r+i>t.length)throw new RangeError("Index out of range")}function Vt(t,e,r,i){e<0&&(e=65535+e+1);for(var n=0,o=Math.min(t.length-r,2);n<o;++n)t[r+n]=(e&255<<8*(i?n:1-n))>>>8*(i?n:1-n)}function zt(t,e,r,i){e<0&&(e=4294967295+e+1);for(var n=0,o=Math.min(t.length-r,4);n<o;++n)t[r+n]=e>>>8*(i?n:3-n)&255}function Ht(t,e,r,i,n,o){if(r+i>t.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function qt(t,e,r,i,n){return n||Ht(t,0,r,4),ut(t,e,r,i,23,4),r+4}function Wt(t,e,r,i,n){return n||Ht(t,0,r,8),ut(t,e,r,i,52,8),r+8}yt.prototype.slice=function(t,e){var r,i=this.length;if((t=~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),(e=void 0===e?i:~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),e<t&&(e=t),yt.TYPED_ARRAY_SUPPORT)(r=this.subarray(t,e)).__proto__=yt.prototype;else{var n=e-t;r=new yt(n,void 0);for(var o=0;o<n;++o)r[o]=this[o+t]}return r},yt.prototype.readUIntLE=function(t,e,r){t|=0,e|=0,r||Yt(t,e,this.length);for(var i=this[t],n=1,o=0;++o<e&&(n*=256);)i+=this[t+o]*n;return i},yt.prototype.readUIntBE=function(t,e,r){t|=0,e|=0,r||Yt(t,e,this.length);for(var i=this[t+--e],n=1;e>0&&(n*=256);)i+=this[t+--e]*n;return i},yt.prototype.readUInt8=function(t,e){return e||Yt(t,1,this.length),this[t]},yt.prototype.readUInt16LE=function(t,e){return e||Yt(t,2,this.length),this[t]|this[t+1]<<8},yt.prototype.readUInt16BE=function(t,e){return e||Yt(t,2,this.length),this[t]<<8|this[t+1]},yt.prototype.readUInt32LE=function(t,e){return e||Yt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},yt.prototype.readUInt32BE=function(t,e){return e||Yt(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},yt.prototype.readIntLE=function(t,e,r){t|=0,e|=0,r||Yt(t,e,this.length);for(var i=this[t],n=1,o=0;++o<e&&(n*=256);)i+=this[t+o]*n;return i>=(n*=128)&&(i-=Math.pow(2,8*e)),i},yt.prototype.readIntBE=function(t,e,r){t|=0,e|=0,r||Yt(t,e,this.length);for(var i=e,n=1,o=this[t+--i];i>0&&(n*=256);)o+=this[t+--i]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*e)),o},yt.prototype.readInt8=function(t,e){return e||Yt(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},yt.prototype.readInt16LE=function(t,e){e||Yt(t,2,this.length);var r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},yt.prototype.readInt16BE=function(t,e){e||Yt(t,2,this.length);var r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},yt.prototype.readInt32LE=function(t,e){return e||Yt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},yt.prototype.readInt32BE=function(t,e){return e||Yt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},yt.prototype.readFloatLE=function(t,e){return e||Yt(t,4,this.length),ct(this,t,!0,23,4)},yt.prototype.readFloatBE=function(t,e){return e||Yt(t,4,this.length),ct(this,t,!1,23,4)},yt.prototype.readDoubleLE=function(t,e){return e||Yt(t,8,this.length),ct(this,t,!0,52,8)},yt.prototype.readDoubleBE=function(t,e){return e||Yt(t,8,this.length),ct(this,t,!1,52,8)},yt.prototype.writeUIntLE=function(t,e,r,i){(t=+t,e|=0,r|=0,i)||jt(this,t,e,r,Math.pow(2,8*r)-1,0);var n=1,o=0;for(this[e]=255&t;++o<r&&(n*=256);)this[e+o]=t/n&255;return e+r},yt.prototype.writeUIntBE=function(t,e,r,i){(t=+t,e|=0,r|=0,i)||jt(this,t,e,r,Math.pow(2,8*r)-1,0);var n=r-1,o=1;for(this[e+n]=255&t;--n>=0&&(o*=256);)this[e+n]=t/o&255;return e+r},yt.prototype.writeUInt8=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,1,255,0),yt.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},yt.prototype.writeUInt16LE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,2,65535,0),yt.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):Vt(this,t,e,!0),e+2},yt.prototype.writeUInt16BE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,2,65535,0),yt.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):Vt(this,t,e,!1),e+2},yt.prototype.writeUInt32LE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,4,4294967295,0),yt.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):zt(this,t,e,!0),e+4},yt.prototype.writeUInt32BE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,4,4294967295,0),yt.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):zt(this,t,e,!1),e+4},yt.prototype.writeIntLE=function(t,e,r,i){if(t=+t,e|=0,!i){var n=Math.pow(2,8*r-1);jt(this,t,e,r,n-1,-n)}var o=0,s=1,a=0;for(this[e]=255&t;++o<r&&(s*=256);)t<0&&0===a&&0!==this[e+o-1]&&(a=1),this[e+o]=(t/s>>0)-a&255;return e+r},yt.prototype.writeIntBE=function(t,e,r,i){if(t=+t,e|=0,!i){var n=Math.pow(2,8*r-1);jt(this,t,e,r,n-1,-n)}var o=r-1,s=1,a=0;for(this[e+o]=255&t;--o>=0&&(s*=256);)t<0&&0===a&&0!==this[e+o+1]&&(a=1),this[e+o]=(t/s>>0)-a&255;return e+r},yt.prototype.writeInt8=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,1,127,-128),yt.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},yt.prototype.writeInt16LE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,2,32767,-32768),yt.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):Vt(this,t,e,!0),e+2},yt.prototype.writeInt16BE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,2,32767,-32768),yt.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):Vt(this,t,e,!1),e+2},yt.prototype.writeInt32LE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,4,2147483647,-2147483648),yt.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):zt(this,t,e,!0),e+4},yt.prototype.writeInt32BE=function(t,e,r){return t=+t,e|=0,r||jt(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),yt.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):zt(this,t,e,!1),e+4},yt.prototype.writeFloatLE=function(t,e,r){return qt(this,t,e,!0,r)},yt.prototype.writeFloatBE=function(t,e,r){return qt(this,t,e,!1,r)},yt.prototype.writeDoubleLE=function(t,e,r){return Wt(this,t,e,!0,r)},yt.prototype.writeDoubleBE=function(t,e,r){return Wt(this,t,e,!1,r)},yt.prototype.copy=function(t,e,r,i){if(r||(r=0),i||0===i||(i=this.length),e>=t.length&&(e=t.length),e||(e=0),i>0&&i<r&&(i=r),i===r)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),t.length-e<i-r&&(i=t.length-e+r);var n,o=i-r;if(this===t&&r<e&&e<i)for(n=o-1;n>=0;--n)t[n+e]=this[n+r];else if(o<1e3||!yt.TYPED_ARRAY_SUPPORT)for(n=0;n<o;++n)t[n+e]=this[n+r];else Uint8Array.prototype.set.call(t,this.subarray(r,r+o),e);return o},yt.prototype.fill=function(t,e,r,i){if("string"==typeof t){if("string"==typeof e?(i=e,e=0,r=this.length):"string"==typeof r&&(i=r,r=this.length),1===t.length){var n=t.charCodeAt(0);n<256&&(t=n)}if(void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!yt.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;var o;if(e>>>=0,r=void 0===r?this.length:r>>>0,t||(t=0),"number"==typeof t)for(o=e;o<r;++o)this[o]=t;else{var s=Et(t)?t:Zt(new yt(t,i).toString()),a=s.length;for(o=0;o<r-e;++o)this[o+e]=s[o%a]}return this};var $t=/[^+\/0-9A-Za-z-_]/g;function Xt(t){return t<16?"0"+t.toString(16):t.toString(16)}function Zt(t,e){var r;e=e||1/0;for(var i=t.length,n=null,o=[],s=0;s<i;++s){if((r=t.charCodeAt(s))>55295&&r<57344){if(!n){if(r>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(s+1===i){(e-=3)>-1&&o.push(239,191,189);continue}n=r;continue}if(r<56320){(e-=3)>-1&&o.push(239,191,189),n=r;continue}r=65536+(n-55296<<10|r-56320)}else n&&(e-=3)>-1&&o.push(239,191,189);if(n=null,r<128){if((e-=1)<0)break;o.push(r)}else if(r<2048){if((e-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function Jt(t){return function(t){var e,r,i,n,o,s;at||ht();var a=t.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===t[a-2]?2:"="===t[a-1]?1:0,s=new st(3*a/4-o),i=o>0?a-4:a;var h=0;for(e=0,r=0;e<i;e+=4,r+=3)n=ot[t.charCodeAt(e)]<<18|ot[t.charCodeAt(e+1)]<<12|ot[t.charCodeAt(e+2)]<<6|ot[t.charCodeAt(e+3)],s[h++]=n>>16&255,s[h++]=n>>8&255,s[h++]=255&n;return 2===o?(n=ot[t.charCodeAt(e)]<<2|ot[t.charCodeAt(e+1)]>>4,s[h++]=255&n):1===o&&(n=ot[t.charCodeAt(e)]<<10|ot[t.charCodeAt(e+1)]<<4|ot[t.charCodeAt(e+2)]>>2,s[h++]=n>>8&255,s[h++]=255&n),s}(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace($t,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function Qt(t,e,r,i){for(var n=0;n<i&&!(n+r>=e.length||n>=t.length);++n)e[n+r]=t[n];return n}function te(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}var ee={};class re extends Z{constructor(t,e){super(),this.response=t,this.dataPromise=e}get status(){return this.response.statusCode}getHeader(t){return this.response.headers[t]}async getData(){return await this.dataPromise}}class ie extends J{constructor(t){super(t),this.parsedUrl=ee.parse(this.url),this.httpApi=(this.parsedUrl.protocol,ee)}constructRequest(t,e){return new Promise(((r,i)=>{const n=this.httpApi.get({...this.parsedUrl,headers:t},(t=>{const e=new Promise((e=>{const r=[];t.on("data",(t=>{r.push(t)})),t.on("end",(()=>{const t=yt.concat(r).buffer;e(t)})),t.on("error",i)}));r(new re(t,e))}));n.on("error",i),e&&(e.aborted&&n.destroy(new z("Request aborted")),e.addEventListener("abort",(()=>n.destroy(new z("Request aborted")))))}))}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}class ne extends N{constructor(t,e,r,i){super(),this.client=t,this.headers=e,this.maxRanges=r,this.allowFullFile=i,this._fileSize=null}async fetch(t,e){return this.maxRanges>=t.length?this.fetchSlices(t,e):(this.maxRanges>0&&t.length,Promise.all(t.map((t=>this.fetchSlice(t,e)))))}async fetchSlices(t,e){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${t.map((({offset:t,length:e})=>`${t}-${t+e}`)).join(",")}`},signal:e});if(r.ok){if(206===r.status){const{type:i,params:n}=function(t){const[e,...r]=t.split(";").map((t=>t.trim()));return{type:e,params:B(r.map((t=>t.split("="))))}}(r.getHeader("content-type"));if("multipart/byteranges"===i){const t=function(t,e){let r=null;const i=new TextDecoder("ascii"),n=[],o=`--${e}`,s=`${o}--`;for(let e=0;e<10;++e)i.decode(new Uint8Array(t,e,o.length))===o&&(r=e);if(null===r)throw new Error("Could not find initial boundary");for(;r<t.byteLength;){const e=i.decode(new Uint8Array(t,r,Math.min(o.length+1024,t.byteLength-r)));if(0===e.length||e.startsWith(s))break;if(!e.startsWith(o))throw new Error("Part does not start with boundary");const a=e.substr(o.length+2);if(0===a.length)break;const h=a.indexOf(F),l=L(a.substr(0,h)),{start:f,end:c,total:u}=x(l["content-range"]),g=r+o.length+h+4,p=parseInt(c,10)+1-parseInt(f,10);n.push({headers:l,data:t.slice(g,g+p),offset:f,length:p,fileSize:u}),r=g+p+4}return n}(await r.getData(),n.boundary);return this._fileSize=t[0].fileSize||null,t}const o=await r.getData(),{start:s,end:a,total:h}=x(r.getHeader("content-range"));this._fileSize=h||null;const l=[{data:o,offset:s,length:a-s}];if(t.length>1){const r=await Promise.all(t.slice(1).map((t=>this.fetchSlice(t,e))));return l.concat(r)}return l}{if(!this.allowFullFile)throw new Error("Server responded with full file");const t=await r.getData();return this._fileSize=t.byteLength,[{data:t,offset:0,length:t.byteLength}]}}throw new Error("Error fetching data.")}async fetchSlice(t,e){const{offset:r,length:i}=t,n=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+i}`},signal:e});if(n.ok){if(206===n.status){const t=await n.getData(),{total:e}=x(n.getHeader("content-range"));return this._fileSize=e||null,{data:t,offset:r,length:i}}{if(!this.allowFullFile)throw new Error("Server responded with full file");const t=await n.getData();return this._fileSize=t.byteLength,{data:t,offset:0,length:t.byteLength}}}throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function oe(t,{blockSize:e,cacheSize:r}){return null===e?t:new X(t,{blockSize:e,cacheSize:r})}function se(t,{forceXHR:e=!1,...r}={}){return"function"!=typeof fetch||e?"undefined"!=typeof XMLHttpRequest?function(t,{headers:e={},maxRanges:r=0,allowFullFile:i=!1,...n}={}){const o=new rt(t);return oe(new ne(o,e,r,i),n)}(t,r):function(t,{headers:e={},maxRanges:r=0,allowFullFile:i=!1,...n}={}){const o=new ie(t);return oe(new ne(o,e,r,i),n)}(t,r):function(t,{headers:e={},credentials:r,maxRanges:i=0,allowFullFile:n=!1,...o}={}){const s=new tt(t,r);return oe(new ne(s,e,i,n),o)}(t,r)}class ae extends N{constructor(t){super(),this.arrayBuffer=t}fetchSlice(t,e){if(e&&e.aborted)throw new z("Request aborted");return this.arrayBuffer.slice(t.offset,t.offset+t.length)}}class he extends N{constructor(t){super(),this.file=t}async fetchSlice(t,e){return new Promise(((r,i)=>{const n=this.file.slice(t.offset,t.offset+t.length),o=new FileReader;o.onload=t=>r(t.target.result),o.onerror=i,o.onabort=i,o.readAsArrayBuffer(n),e&&e.addEventListener("abort",(()=>o.abort()))}))}}class le extends N{constructor(t){super(),this.path=t,this.openRequest=function(t,e,r){return new Promise(((i,n)=>{ee.open(t,e,r,((t,e)=>{t?n(t):i(e)}))}))}(t,"r")}async fetchSlice(t){const e=await this.openRequest,{buffer:r}=await function(...t){return new Promise(((e,r)=>{ee.read(...t,((t,i,n)=>{t?r(t):e({bytesRead:i,buffer:n})}))}))}(e,yt.alloc(t.length),0,t.length,t.offset);return r.buffer}async close(){const t=await this.openRequest;await function(t){return new Promise(((e,r)=>{ee.close(t,(t=>{t?r(t):e()}))}))}(t)}}const fe=j(n),ce=j(u),ue={};K(ue,fe),K(ue,ce);const ge=j(h),pe=1e3,de={nextZero:(t,e)=>{let r=e;for(;0!==t[r];)r++;return r},readUshort:(t,e)=>t[e]<<8|t[e+1],readShort:(t,e)=>{const r=de.ui8;return r[0]=t[e+1],r[1]=t[e+0],de.i16[0]},readInt:(t,e)=>{const r=de.ui8;return r[0]=t[e+3],r[1]=t[e+2],r[2]=t[e+1],r[3]=t[e+0],de.i32[0]},readUint:(t,e)=>{const r=de.ui8;return r[0]=t[e+3],r[1]=t[e+2],r[2]=t[e+1],r[3]=t[e+0],de.ui32[0]},readASCII:(t,e,r)=>r.map((r=>String.fromCharCode(t[e+r]))).join(""),readFloat:(t,e)=>{const r=de.ui8;return V(4,(i=>{r[i]=t[e+3-i]})),de.fl32[0]},readDouble:(t,e)=>{const r=de.ui8;return V(8,(i=>{r[i]=t[e+7-i]})),de.fl64[0]},writeUshort:(t,e,r)=>{t[e]=r>>8&255,t[e+1]=255&r},writeUint:(t,e,r)=>{t[e]=r>>24&255,t[e+1]=r>>16&255,t[e+2]=r>>8&255,t[e+3]=r>>0&255},writeASCII:(t,e,r)=>{V(r.length,(i=>{t[e+i]=r.charCodeAt(i)}))},ui8:new Uint8Array(8)};de.fl64=new Float64Array(de.ui8.buffer),de.writeDouble=(t,e,r)=>{de.fl64[0]=r,V(8,(r=>{t[e+r]=de.ui8[7-r]}))};const we=t=>{const e=new Uint8Array(pe);let r=4;const i=de;e[0]=77,e[1]=77,e[3]=42;let n=8;if(i.writeUint(e,r,n),r+=4,t.forEach(((r,o)=>{const a=((t,e,r,i)=>{let n=r;const o=Object.keys(i).filter((t=>null!=t&&"undefined"!==t));t.writeUshort(e,n,o.length),n+=2;let a=n+12*o.length+4;for(const r of o){let o=null;"number"==typeof r?o=r:"string"==typeof r&&(o=parseInt(r,10));const h=s[o],l=ge[h];if(null==h||void 0===h||void 0===h)throw new Error(`unknown type of tag: ${o}`);let f=i[r];if(void 0===f)throw new Error(`failed to get value for key ${r}`);"ASCII"===h&&"string"==typeof f&&!1===Y(f,"\0")&&(f+="\0");const c=f.length;t.writeUshort(e,n,o),n+=2,t.writeUshort(e,n,l),n+=2,t.writeUint(e,n,c),n+=4;let u=[-1,1,1,2,4,8,0,0,0,0,0,0,8][l]*c,g=n;u>4&&(t.writeUint(e,n,a),g=a),"ASCII"===h?t.writeASCII(e,g,f):"SHORT"===h?V(c,(r=>{t.writeUshort(e,g+2*r,f[r])})):"LONG"===h?V(c,(r=>{t.writeUint(e,g+4*r,f[r])})):"RATIONAL"===h?V(c,(r=>{t.writeUint(e,g+8*r,Math.round(1e4*f[r])),t.writeUint(e,g+8*r+4,1e4)})):"DOUBLE"===h&&V(c,(r=>{t.writeDouble(e,g+8*r,f[r])})),u>4&&(u+=1&u,a+=u),n+=4}return[n,a]})(i,e,n,r);n=a[1],o<t.length-1&&i.writeUint(e,a[0],n)})),e.slice)return e.slice(0,n).buffer;const o=new Uint8Array(n);for(let t=0;t<n;t++)o[t]=e[t];return o.buffer},ye=(t,e,r,i)=>{if(null==r)throw new Error(`you passed into encodeImage a width of type ${r}`);if(null==e)throw new Error(`you passed into encodeImage a width of type ${e}`);const n={256:[e],257:[r],273:[pe],278:[r],305:"geotiff.js"};if(i)for(const t in i)i.hasOwnProperty(t)&&(n[t]=i[t]);const o=new Uint8Array(we([n])),s=new Uint8Array(t),a=n[277],h=new Uint8Array(pe+e*r*a);return V(o.length,(t=>{h[t]=o[t]})),function(t,e){const{length:r}=t;for(let i=0;i<r;i++)e(t[i],i)}(s,((t,e)=>{h[pe+e]=t})),h.buffer},me=t=>{const e={};for(const r in t)"StripOffsets"!==r&&(ue[r]||console.error(r,"not in name2code:",Object.keys(ue)),e[ue[r]]=t[r]);return e},be=t=>Array.isArray(t)?t:[t],Se=[["Compression",1],["PlanarConfiguration",1],["ExtraSamples",0]];class Ae{log(){}debug(){}info(){}warn(){}error(){}time(){}timeEnd(){}}function Te(t=new Ae){}function Ee(t,e){let r=t.length-e,i=0;do{for(let r=e;r>0;r--)t[i+e]+=t[i],i++;r-=e}while(r>0)}function Ie(t,e,r){let i=0,n=t.length;const o=n/r;for(;n>e;){for(let r=e;r>0;--r)t[i+e]+=t[i],++i;n-=e}const s=t.slice();for(let e=0;e<o;++e)for(let i=0;i<r;++i)t[r*e+i]=s[(r-i-1)*o+e]}class Pe{async decode(t,e){const r=await this.decodeBlock(e),i=t.Predictor||1;if(1!==i){const e=!t.StripOffsets;return function(t,e,r,i,n,o){if(!e||1===e)return t;for(let t=0;t<n.length;++t){if(n[t]%8!=0)throw new Error("When decoding with predictor, only multiple of 8 bits are supported.");if(n[t]!==n[0])throw new Error("When decoding with predictor, all samples must have the same size.")}const s=n[0]/8,a=2===o?1:n.length;for(let o=0;o<i&&!(o*a*r*s>=t.byteLength);++o){let i;if(2===e){switch(n[0]){case 8:i=new Uint8Array(t,o*a*r*s,a*r*s);break;case 16:i=new Uint16Array(t,o*a*r*s,a*r*s/2);break;case 32:i=new Uint32Array(t,o*a*r*s,a*r*s/4);break;default:throw new Error(`Predictor 2 not allowed with ${n[0]} bits per sample.`)}Ee(i,a)}else 3===e&&(i=new Uint8Array(t,o*a*r*s,a*r*s),Ie(i,a,s))}return t}(r,i,e?t.TileWidth:t.ImageWidth,e?t.TileLength:t.RowsPerStrip||t.ImageLength,t.BitsPerSample,t.PlanarConfiguration)}return r}}function Re(t){switch(t){case l.BYTE:case l.ASCII:case l.SBYTE:case l.UNDEFINED:return 1;case l.SHORT:case l.SSHORT:return 2;case l.LONG:case l.SLONG:case l.FLOAT:case l.IFD:return 4;case l.RATIONAL:case l.SRATIONAL:case l.DOUBLE:case l.LONG8:case l.SLONG8:case l.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${t}`)}}function De(t,e,r,i){let n=null,o=null;const s=Re(e);switch(e){case l.BYTE:case l.ASCII:case l.UNDEFINED:n=new Uint8Array(r),o=t.readUint8;break;case l.SBYTE:n=new Int8Array(r),o=t.readInt8;break;case l.SHORT:n=new Uint16Array(r),o=t.readUint16;break;case l.SSHORT:n=new Int16Array(r),o=t.readInt16;break;case l.LONG:case l.IFD:n=new Uint32Array(r),o=t.readUint32;break;case l.SLONG:n=new Int32Array(r),o=t.readInt32;break;case l.LONG8:case l.IFD8:n=new Array(r),o=t.readUint64;break;case l.SLONG8:n=new Array(r),o=t.readInt64;break;case l.RATIONAL:n=new Uint32Array(2*r),o=t.readUint32;break;case l.SRATIONAL:n=new Int32Array(2*r),o=t.readInt32;break;case l.FLOAT:n=new Float32Array(r),o=t.readFloat32;break;case l.DOUBLE:n=new Float64Array(r),o=t.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e!==l.RATIONAL&&e!==l.SRATIONAL)for(let e=0;e<r;++e)n[e]=o.call(t,i+e*s);else for(let e=0;e<r;e+=2)n[e]=o.call(t,i+e*s),n[e+1]=o.call(t,i+(e*s+4));return e===l.ASCII?new TextDecoder("utf-8").decode(n):n}class Ue{constructor(t,e,r){this.fileDirectory=t,this.geoKeyDirectory=e,this.nextIFDByteOffset=r}}class Oe extends Error{constructor(t){super(`No image at index ${t}`),this.index=t}}class ve{async readRasters(t={}){const{window:e,width:r,height:i}=t;let{resX:n,resY:o,bbox:s}=t;const a=await this.getImage();let h=a;const l=await this.getImageCount(),f=a.getBoundingBox();if(e&&s)throw new Error('Both "bbox" and "window" passed.');if(r||i){if(e){const[t,r]=a.getOrigin(),[i,n]=a.getResolution();s=[t+e[0]*i,r+e[1]*n,t+e[2]*i,r+e[3]*n]}const t=s||f;if(r){if(n)throw new Error("Both width and resX passed");n=(t[2]-t[0])/r}if(i){if(o)throw new Error("Both width and resY passed");o=(t[3]-t[1])/i}}if(n||o){const t=[];for(let e=0;e<l;++e){const r=await this.getImage(e),{SubfileType:i,NewSubfileType:n}=r.fileDirectory;(0===e||2===i||1&n)&&t.push(r)}t.sort(((t,e)=>t.getWidth()-e.getWidth()));for(let e=0;e<t.length;++e){const r=t[e],i=(f[2]-f[0])/r.getWidth(),s=(f[3]-f[1])/r.getHeight();if(h=r,n&&n>i||o&&o>s)break}}let c=e;if(s){const[t,e]=a.getOrigin(),[r,i]=h.getResolution(a);c=[Math.round((s[0]-t)/r),Math.round((s[1]-e)/i),Math.round((s[2]-t)/r),Math.round((s[3]-e)/i)],c=[Math.min(c[0],c[2]),Math.min(c[1],c[3]),Math.max(c[0],c[2]),Math.max(c[1],c[3])]}return h.readRasters({...t,window:c})}}class Ce extends ve{constructor(t,e,r,i,n={}){super(),this.source=t,this.littleEndian=e,this.bigTiff=r,this.firstIFDOffset=i,this.cache=n.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(t,e){const r=this.bigTiff?4048:1024;return new _((await this.source.fetch([{offset:t,length:void 0!==e?e:r}]))[0],t,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(t){const e=this.bigTiff?20:12,r=this.bigTiff?8:2;let i=await this.getSlice(t);const o=this.bigTiff?i.readUint64(t):i.readUint16(t),s=o*e+(this.bigTiff?16:6);i.covers(t,s)||(i=await this.getSlice(t,s));const h={};let f=t+(this.bigTiff?8:2);for(let t=0;t<o;f+=e,++t){const t=i.readUint16(f),e=i.readUint16(f+2),r=this.bigTiff?i.readUint64(f+4):i.readUint32(f+4);let o,s;const c=Re(e),u=f+(this.bigTiff?12:8);if(c*r<=(this.bigTiff?8:4))o=De(i,e,r,u);else{const t=i.readOffset(u),n=Re(e)*r;if(i.covers(t,n))o=De(i,e,r,t);else{o=De(await this.getSlice(t,n),e,r,t)}}s=1===r&&-1===a.indexOf(t)&&e!==l.RATIONAL&&e!==l.SRATIONAL?o[0]:o,h[n[t]]=s}const c=function(t){const e=t.GeoKeyDirectory;if(!e)return null;const r={};for(let i=4;i<=4*e[3];i+=4){const o=u[e[i]],s=e[i+1]?n[e[i+1]]:null,a=e[i+2],h=e[i+3];let l=null;if(s){if(l=t[s],null==l)throw new Error(`Could not get value of geoKey '${o}'.`);"string"==typeof l?l=l.substring(h,h+a-1):l.subarray&&(l=l.subarray(h,h+a),1===a&&(l=l[0]))}else l=h;r[o]=l}return r}(h),g=i.readOffset(t+r+e*o);return new Ue(h,c,g)}async requestIFD(t){if(this.ifdRequests[t])return this.ifdRequests[t];if(0===t)return this.ifdRequests[t]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[t];if(!this.ifdRequests[t-1])try{this.ifdRequests[t-1]=this.requestIFD(t-1)}catch(e){if(e instanceof Oe)throw new Oe(t);throw e}return this.ifdRequests[t]=(async()=>{const e=await this.ifdRequests[t-1];if(0===e.nextIFDByteOffset)throw new Oe(t);return this.parseFileDirectoryAt(e.nextIFDByteOffset)})(),this.ifdRequests[t]}async getImage(t=0){const e=await this.requestIFD(t);return new C(e.fileDirectory,e.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let t=0,e=!0;for(;e;)try{await this.requestIFD(t),++t}catch(t){if(!(t instanceof Oe))throw t;e=!1}return t}async getGhostValues(){const t=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const e="GDAL_STRUCTURAL_METADATA_SIZE=";let r=await this.getSlice(t,130);if(e===De(r,l.ASCII,30,t)){const e=De(r,l.ASCII,130,t).split("\n")[0],i=Number(e.split("=")[1].split(" ")[0])+e.length;i>130&&(r=await this.getSlice(t,i));const n=De(r,l.ASCII,i,t);this.ghostValues={},n.split("\n").filter((t=>t.length>0)).map((t=>t.split("="))).forEach((([t,e])=>{this.ghostValues[t]=e}))}return this.ghostValues}static async fromSource(t,e,r){const i=(await t.fetch([{offset:0,length:1024}],r))[0],n=new M(i),o=n.getUint16(0,0);let s;if(18761===o)s=!0;else{if(19789!==o)throw new TypeError("Invalid byte order value.");s=!1}const a=n.getUint16(2,s);let h;if(42===a)h=!1;else{if(43!==a)throw new TypeError("Invalid magic number.");h=!0;if(8!==n.getUint16(4,s))throw new Error("Unsupported offset byte-size.")}const l=h?n.getUint64(8,s):n.getUint32(4,s);return new Ce(t,s,h,l,e)}close(){return"function"==typeof this.source.close&&this.source.close()}}class Me extends ve{constructor(t,e){super(),this.mainFile=t,this.overviewFiles=e,this.imageFiles=[t].concat(e),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const t=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map((t=>t.parseFileDirectoryAt(t.firstIFDOffset))));return this.fileDirectoriesPerFile=await Promise.all(t),this.fileDirectoriesPerFile}async getImage(t=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let e=0,r=0;for(let i=0;i<this.imageFiles.length;i++){const n=this.imageFiles[i];for(let o=0;o<this.imageCounts[i];o++){if(t===e){const t=await n.requestIFD(r);return new C(t.fileDirectory,t.geoKeyDirectory,n.dataView,n.littleEndian,n.cache,n.source)}e++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(null!==this.imageCount)return this.imageCount;const t=[this.mainFile.getImageCount()].concat(this.overviewFiles.map((t=>t.getImageCount())));return this.imageCounts=await Promise.all(t),this.imageCount=this.imageCounts.reduce(((t,e)=>t+e),0),this.imageCount}}async function _e(t,e={},r){return Ce.fromSource(se(t,e),r)}async function Ge(t,e={},r){return Ce.fromSource(function(t,{headers:e={},maxRanges:r=0,allowFullFile:i=!1,...n}={}){return oe(new ne(t,e,r,i),n)}(t,e),r)}async function ke(t,e){return Ce.fromSource(function(t){return new ae(t)}(t),e)}async function Fe(t,e){return Ce.fromSource(function(t){return new le(t)}(t),e)}async function Be(t,e){return Ce.fromSource(new he(t),e)}async function Le(t,e=[],r={},i){const n=await Ce.fromSource(se(t,r),i),o=await Promise.all(e.map((t=>Ce.fromSource(se(t,r)))));return new Me(n,o)}function xe(t,e){return function(t,e){let r,i,n,o;"number"==typeof t[0]?(r=e.height||e.ImageLength,n=e.width||e.ImageWidth,i=t.length/(r*n),o=t):(i=t.length,r=t[0].length,n=t[0][0].length,o=[],V(r,(e=>{V(n,(r=>{V(i,(i=>{o.push(t[i][e][r])}))}))}))),e.ImageLength=r,delete e.height,e.ImageWidth=n,delete e.width,e.BitsPerSample||(e.BitsPerSample=V(i,(()=>8))),Se.forEach((t=>{const r=t[0];if(!e[r]){const i=t[1];e[r]=i}})),e.PhotometricInterpretation||(e.PhotometricInterpretation=3===e.BitsPerSample.length?2:1),e.SamplesPerPixel||(e.SamplesPerPixel=[i]),e.StripByteCounts||(e.StripByteCounts=[i*r*n]),e.ModelPixelScale||(e.ModelPixelScale=[360/n,180/r,0]),e.SampleFormat||(e.SampleFormat=V(i,(()=>1))),e.hasOwnProperty("GeographicTypeGeoKey")||e.hasOwnProperty("ProjectedCSTypeGeoKey")||(e.GeographicTypeGeoKey=4326,e.ModelTiepoint=[0,0,0,-180,90,0],e.GeogCitationGeoKey="WGS 84",e.GTModelTypeGeoKey=2);const a=Object.keys(e).filter((t=>Y(t,"GeoKey"))).sort(((t,e)=>ue[t]-ue[e]));if(!e.GeoAsciiParams){let t="";a.forEach((r=>{const i=Number(ue[r]);"ASCII"===s[i]&&(t+=`${e[r].toString()}\0`)})),t.length>0&&(e.GeoAsciiParams=t)}if(!e.GeoKeyDirectory){const t=[1,1,0,a.length];a.forEach((r=>{const i=Number(ue[r]);let n,o,a;t.push(i),"SHORT"===s[i]?(n=1,o=0,a=e[r]):"GeogCitationGeoKey"===r?(n=e.GeoAsciiParams.length,o=Number(ue.GeoAsciiParams),a=0):console.log(`[geotiff.js] couldn't get TIFFTagLocation for ${r}`),t.push(o),t.push(n),t.push(a)})),e.GeoKeyDirectory=t}for(const t of a)e.hasOwnProperty(t)&&delete e[t];["Compression","ExtraSamples","GeographicTypeGeoKey","GTModelTypeGeoKey","GTRasterTypeGeoKey","ImageLength","ImageWidth","Orientation","PhotometricInterpretation","ProjectedCSTypeGeoKey","PlanarConfiguration","ResolutionUnit","SamplesPerPixel","XPosition","YPosition","RowsPerStrip"].forEach((t=>{e[t]&&(e[t]=be(e[t]))}));const h=me(e);return ye(o,n,r,h)}(t,e)}export{J as BaseClient,Pe as BaseDecoder,Z as BaseResponse,Ce as GeoTIFF,C as GeoTIFFImage,Me as MultiGeoTIFF,k as Pool,E as addDecoder,Ce as default,ke as fromArrayBuffer,Be as fromBlob,Ge as fromCustomClient,Fe as fromFile,_e as fromUrl,Le as fromUrls,I as getDecoder,p as globals,A as rgb,Te as setLogger,xe as writeArrayBuffer};
